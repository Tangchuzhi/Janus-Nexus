# DMSS (Dynamic Memory Stream System) 使用说明

## 概述

DMSS（动态记忆流系统）是Janus百宝箱的核心功能之一，专门用于处理长剧情记忆管理。系统采用混合存储模式（Chat-based Chunks + 角色卡索引），能够自动处理AI响应中的DMSS指令，并在聊天区域直接输出处理结果。

## 功能特性

### 1. 核心功能
- **混合存储模式**：结合聊天块和角色卡索引的存储方式
- **自动指令处理**：自动识别和处理AI响应中的DMSS指令
- **实时聊天输出**：处理结果直接在聊天区域显示
- **角色记忆管理**：为每个角色独立管理记忆数据

### 2. 支持的操作类型
- **CREATE**：创建新条目
- **APPEND**：增量追加内容
- **MOVE**：区域移动
- **COMPRESS**：记忆压缩

### 3. 条目类型
- **C_编号_角色**：角色档案
- **G_编号_组织**：组织档案
- **T_编号_物品**：物品档案
- **A_编号_伏笔/约定/线索**：伏笔线索
- **P_编号_并行事件**：并行事件

## 使用方法

### 1. 激活DMSS系统

#### 通过UI界面
1. 打开Janus百宝箱设置
2. 切换到DMSS标签页
3. 开启"为当前角色启用DMSS"开关

#### 通过Slash命令
```
/dmss-activate [角色名]
```

### 2. AI提示词配置

在AI的系统提示词中添加以下内容：

```
Janus, after </content> must IMMEDIATELY use the DMSS (Dynamic Memory Stream System), starting with <DMSS> and concluding with </DMSS> in zh-CN. 

# DMSS更新指令生成规则
输出格式: 单行JSON数组，每个指令对象结构：[{"action":"ACTION","target":"ID.field","payload":{}}]

## 指令动作类型
CREATE - 创建新条目
- target: 新条目ID 
- payload: 完整初始内容JSON对象

APPEND - 增量追加
- target: 具体字段路径 (如C_001.核心驱动或E_003_酒馆冲突)
- payload: {"content":"追加文本","timestamp":"日期","location":"地点"}

MOVE - 区域移动  
- target: 条目ID
- payload: {"from":"备用区","to":"档案区","new_id":"新ID"}

COMPRESS - 记忆压缩
- target: 角色.人生履历
- payload: {"arc_id":"ARC_章节","arc_summary":"完整章节总结","events_to_delete":["E_001","E_002"]}

## DMSS条目类型
档案区: C_编号_角色, G_编号_组织, T_编号_物品
备用区: P_编号_并行事件, C_编号_角色, G_编号_组织, A_编号_伏笔/约定/线索

## Payload内容规范
C_角色: {"核心驱动":"文本","关系网":{"姓名":"关系"},"人生履历":{"ARC_章节":"该章节的二次精炼总结, 包含地点、所有参与人物、起因、经过、关键转折、结局、深远影响,以及对角色世界观/能力/人际关系/...etc.造成的永久性改变","E_编号_事件名":"事件摘要"}}
G_组织: {"构成":"文本","特征":"文本","理念":"文本","社会地位":"文本"}  
T_物品: {"持有者":"C_编号","事件摘要":"文本","意义与影响":"文本"}
A_伏笔/约定/线索: {"摘要":"事件描述, 包含时间、地点、人物","激活条件":"文本"}
P_并行: {"摘要":"事件描述, 包含时间、地点、人物","潜在影响":"文本","激活条件":"文本"}

输出示例格式: 
<DMSS>
[{"action":"APPEND","target":"C_01.人生履历.E_003_酒馆冲突","payload":{"content":"守卫赶到","timestamp":"2025-09-15","location":"吧台前"}}]
</DMSS>

注意事项:
1. 双区原则: "备用区"记录场外但活跃的元素; "档案区"是所有角色与组织的核心档案。
2. 每个角色必须在"档案区"建立基础档案。
3. 当AI认为一个完整的故事章节结束时，必须执行一次COMPRESS
4. ARC_章节一经生成, 禁止APPEND, 修改, 删除。
```

### 3. DMSS指令示例

#### 创建角色档案
```json
<DMSS>
[{"action":"CREATE","target":"C_001_主角","payload":{"核心驱动":"寻找失散的家人","关系网":{"导师":"C_002_老法师","敌人":"C_003_黑暗领主"},"人生履历":{}}}]
</DMSS>
```

#### 追加事件记录
```json
<DMSS>
[{"action":"APPEND","target":"C_001_主角.人生履历.E_001_初遇导师","payload":{"content":"在森林中遇到了神秘的老法师","timestamp":"2025-01-15","location":"迷雾森林"}}]
</DMSS>
```

#### 压缩记忆
```json
<DMSS>
[{"action":"COMPRESS","target":"C_001_主角.人生履历","payload":{"arc_id":"ARC_第一章_觉醒","arc_summary":"主角在森林中觉醒魔法能力，遇到导师，开始学习魔法基础","events_to_delete":["E_001_初遇导师","E_002_魔法觉醒"]}}]
</DMSS>
```

### 4. 管理功能

#### 查看记忆
- 点击"查看记忆"按钮查看当前角色的所有记忆数据
- 数据会在浏览器控制台中显示

#### 压缩归档
- 点击"压缩归档"按钮清理7天前的过期记忆
- 系统会自动保存更改

#### 导出记忆
- 点击"导出记忆"按钮下载当前角色的记忆数据
- 文件格式为JSON，包含完整的记忆结构

#### 检查完整性
- 点击"检查记忆文件完整性"按钮验证记忆数据
- 结果会在控制台中显示

### 5. Slash命令

系统提供以下Slash命令：

- `/dmss-activate [角色名]` - 激活DMSS系统
- `/dmss-deactivate` - 停用DMSS系统
- `/dmss-status` - 查看DMSS状态
- `/dmss-cleanup [天数]` - 清理过期记忆

## 技术特性

### 1. 自动处理
- 系统会自动监听AI响应和消息发送事件
- 自动提取和处理DMSS指令
- 处理结果直接在聊天区域显示

### 2. 数据存储
- 使用浏览器localStorage存储记忆数据
- 每个角色独立存储
- 支持自动保存和手动保存

### 3. 错误处理
- 完善的错误处理机制
- 详细的日志记录
- 用户友好的错误提示

### 4. 性能优化
- 30秒自动保存间隔
- 内存中的快速访问
- 过期数据自动清理

## 注意事项

1. **系统依赖**：需要SillyTavern环境和jQuery支持
2. **数据安全**：记忆数据存储在浏览器本地，清除浏览器数据会丢失
3. **角色切换**：切换角色时会自动加载对应的记忆数据
4. **指令格式**：DMSS指令必须严格按照JSON格式编写
5. **中文支持**：系统完全支持中文内容处理

## 故障排除

### 常见问题

1. **DMSS系统未激活**
   - 检查是否开启了角色DMSS开关
   - 确认当前角色存在

2. **指令处理失败**
   - 检查JSON格式是否正确
   - 确认指令类型和参数是否匹配

3. **记忆数据丢失**
   - 检查浏览器localStorage是否被清除
   - 尝试重新激活系统

4. **UI状态不更新**
   - 刷新页面重新加载
   - 检查控制台是否有错误信息

### 调试信息

系统会在浏览器控制台输出详细的调试信息：
- `[DMSS Core]` - 核心系统日志
- `[DMSS API]` - API接口日志
- `[Janusの百宝箱]` - 主系统日志

通过查看这些日志可以快速定位问题。
